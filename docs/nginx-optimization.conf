# Nginx Configuration for Optimized Static File Serving
# Add this to your nginx server block or include from nginx.conf
#
# This configuration is optimized for a low-resource server (0.5 CPU, limited RAM)
# Key features:
# - gzip_static for pre-compressed files (reduces CPU usage)
# - Long cache times for static assets (reduces repeated requests)
# - Proper MIME types for modern formats
# - Brotli compression (if module installed)

# ============================================================================
# GZIP Compression (Pre-compressed + Dynamic)
# ============================================================================

# Serve pre-compressed .gz files if available (reduces CPU load)
gzip_static on;

# Enable dynamic gzip for files not pre-compressed
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 5;  # Balance between CPU usage and compression
gzip_min_length 256;
gzip_types
    application/atom+xml
    application/javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rss+xml
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy
    text/xml;

# ============================================================================
# Brotli Compression (Optional - requires ngx_brotli module)
# ============================================================================
# Uncomment if you have brotli module installed:
# brotli_static on;
# brotli on;
# brotli_comp_level 4;
# brotli_types application/javascript application/json text/css text/plain;

# ============================================================================
# Cache Control Headers
# ============================================================================

# Static assets with hash in filename - cache for 1 year
location ~* \.(js|css|woff2?|ttf|eot|otf)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    access_log off;
}

# Images - cache for 1 year (they have content hash in filename)
location ~* \.(png|jpe?g|gif|webp|avif|svg|ico)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# Videos - cache for 1 year
location ~* \.(mp4|webm|ogg|mov)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# HTML - short cache with revalidation
location ~* \.html$ {
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
}

# ============================================================================
# Modern Image Format Support
# ============================================================================

# Add WebP MIME type if not already in mime.types
types {
    image/webp webp;
    image/avif avif;
    font/woff2 woff2;
    application/manifest+json webmanifest;
}

# ============================================================================
# Security Headers (Bonus - good practice)
# ============================================================================
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;

# ============================================================================
# SPA Routing - Fallback to index.html
# ============================================================================
location / {
    try_files $uri $uri/ /index.html;
}

# ============================================================================
# Generate Pre-compressed Files (run after build)
# ============================================================================
# Run this command after npm run build:prod to create .gz versions:
#
# find dist -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.json" -o -name "*.svg" \) -exec gzip -9 -k {} \;
#
# This creates .gz files alongside originals, which nginx serves via gzip_static
